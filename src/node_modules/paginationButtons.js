const bel = require('bel')
const csjs = require('csjs-inject')
const makeCollectionArea = require('makeCollectionArea')
let css
let activeEl

module.exports = paginationButtons

function paginationButtons (collectionContainer, ops ) {
  let el = bel`
    <div class=${css.pagination}>
      <button class="${css.button} ${css.round} ${css.previous}" onclick=${()=>goToPrevious(ops, collectionContainer)}>Previous</button>
      ${addPages(ops, collectionContainer)}
      <button class="${css.button} ${css.default} ${css.round} ${css.next} " onclick=${()=>goToNext(ops, collectionContainer)}>Next</button>
    </div>`
  return el
}

// ===== helper functions =====

function addPages (ops, container) {
  pageCount = ops.pageCount
  let firstPage = bel`<span
    onclick=${(e)=>selectPage(e, ops, container, pages, 1)}
    class=${css.active}> 1 </span>`
  activeEl = firstPage
  let pages = bel`<ul class=${css.pages}><li>${firstPage}</li></ul>`
  if (pageCount < 6) {
    for (var i=1; i<pageCount; i++) { append(ops, container, pages, i + 1) }
    pages.style.setProperty('--grid-template', `auto / repeat(${pageCount}, 45px)`)
  } else {
    ;[2, '...', pageCount-1, pageCount].forEach(page => append(ops, container, pages, page))
    pages.style.setProperty('--grid-template', `auto / repeat(5, 45px)`)
  }
  return pages
}

function append (ops, container, pages, page) {
  if (page != '...') {
    pages.appendChild(bel`<li><span
      onclick=${(e)=>selectPage(e, ops, container, pages, page)}
      class=${css.nonactive}>${page}
      </span></li>`)
  } else {
    pages.appendChild(bel`<li><span class=${css.nonactive}>${page}</span></li>`)
  }
}

function selectPage (e, ops, container, pages, page) {
  if (activeEl) {
    activeEl.classList.remove(css.active)
    activeEl.classList.add(css.nonactive)
  }
  e.target.classList.remove(css.nonactive)
  e.target.classList.add(css.active)
  activeEl = e.target
  goToUrl(ops, container, page)
}

function getCurrentPage () {
  return parseInt(window.location.href.split('/?page=')[1]) || 1
}

function goToNext (ops, collectionContainer) {
  let currentPage = getCurrentPage()
  let newPage = currentPage + 1
  if (currentPage != ops.lastPage) goToUrl(ops, collectionContainer, newPage)
}

function goToPrevious (ops, collectionContainer) {
  let currentPage = getCurrentPage()
  let newPage = currentPage - 1
  if (currentPage != 1) goToUrl(ops, collectionContainer, newPage)
}

function makeNewCollection (ops, collectionContainer, newPage) {
  const old = collectionContainer.children[0]
  const newCollection = makeCollectionArea(ops.datas[newPage - 1])
  collectionContainer.replaceChild(newCollection, old)
}

function goToUrl(ops, collectionContainer, newPage) {
  const url = getCurrentPage() != 1 ?
   `${window.location.origin}${window.location.pathname}`.split('/?page=')[0] + `?page=${newPage}`
   : `/?page=${newPage}`
  history.pushState(null, null, url);
  makeNewCollection(ops, collectionContainer, newPage)
}


// ===== css =====
css = csjs`
  .pagination {
    grid-area: pagination;
    text-align: center;
    padding-bottom: 60px;
  }
  .button {
    width: 123px;
    height: 44px;
    border: var(--button-border);
    background-color: var(--button-white);
    color: var(--button-default-text);
    font-size: 18px;
    line-height: 44px;
    transition: all .3s ease-in-out;
  }
  .button:hover {
    background-color: var(--button-default-hover);
    color:  var(--button-default-text-hover);
    cursor: pointer;
  }
  .previous {
    border: var(--button-border);
  }
  .next {
  }
  .round {
    border-radius: 22px;
  }
  .default {
    background-color: var(--button-default);
  }
  .pages {
    margin: 0 10px;
    display: inline-grid;
    grid-template: var(--grid-template);
    justify-content: center;
    justify-items: center;
    align-items: center;
  }
  .pages li {
    font-size: var(--text-normal);
    color: #8d8d8d8;
  }
  .nonactive {
    border-radius: 4px;
    padding: 4px 8px;
    border: var(--pages-border);
    color: var(--pages-text);
  }
  .nonactive:hover {
    background: var(--pages-hover-background);
    cursor: pointer;
  }
  .active {
    border-radius: 4px;
    padding: 4px 8px;
    background: var(--pages-current-background);
  }

  @media (max-width: 560px) {
    .pages {
      display: none;
    }
    .pagination {
      display: grid;
      grid-template-columns: 1fr 1fr;
      justify-content: space-between;
    }
    .previous {
      justify-self: start;
    }
    .next {
      justify-self: end;
    }
  }
`
