const SDK = require('dat-sdk')
const { Hypercore, Hyperdrive, resolveName, deleteStorage, destroy } = SDK()
const moloch = require('./moloch-demo.sol')

const url = 'dat://c610858d82e4c9bc9585bb26fedb260c080ed24c6a05bcf3da9ad73a6917ac82/'

const archive = Hyperdrive(url)

let contracts = []
let titles = []
let hashes = []

// ADD MOLOCH DAO - for the demo @TODO remove after the demo
contracts.push(moloch)
titles.push('Moloch.sol')
hashes.push('0x1234567345678903456')

let counter = 0

module.exports = getContracts

function getContracts (done) {
  archive.ready(() => {
    archive.readdir('.', (err, addresses) => {
      if (err) console.log(err)
      if (addresses) {
        for (var i=0; i<addresses.length; i++) {
          getContractsArr(i, addresses, done)
        }
      }
    })
  })
}

// loop over address/src/contractsArr
function getContractsArr (x, addresses, done) {
  archive.readdir(`${addresses[x]}/src/`, (err, contractsArr) => {
    if (addresses[x]) hashes.push(addresses[x])
    if (err) console.log(err)
    if (contractsArr) {
      counter = counter + contractsArr.length
      for (var i=0; i<contractsArr.length; i++) {
        getSourceCode(x, i, addresses, contractsArr, hashes, done)
      }
    }
  })
}

// get source code and oush it to `contracts` array
function getSourceCode (x, i, addresses, contractsArr, hashes, done) {
  archive.readFile(`${addresses[x]}/src/${contractsArr[i]}`, 'utf8', (err, contract) => {
    if (err) console.log(err)
    if (contract) contracts.push(contract)
    if (contractsArr[i]) titles.push(contractsArr[i])
    if (counter === contracts.length) done(contracts, titles, hashes)
  })
}
