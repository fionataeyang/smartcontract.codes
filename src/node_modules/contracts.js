const SDK = require('dat-sdk')
const { Hypercore, Hyperdrive, resolveName, deleteStorage, destroy } = SDK()

const url = 'dat://c610858d82e4c9bc9585bb26fedb260c080ed24c6a05bcf3da9ad73a6917ac82/'

const archive = Hyperdrive(url)

let contracts = []
let counter = 0

module.exports = getContracts

function getContracts (done) {
  archive.ready(() => {
    archive.readdir('.', (err, addresses) => {
      if (err) console.log(err)
      if (addresses) {
        for (var i=0; i<addresses.length; i++) {
          getContractsArr(i, addresses, done)
        }
      }
    })
  })
}

// loop over address/src/contractsArr
function getContractsArr (x, addresses, done) {
  archive.readdir(`${addresses[x]}/src/`, (err, contractsArr) => {
    if (err) console.log(err)
    if (contractsArr) {
      counter = counter + contractsArr.length
      for (var i=0; i<contractsArr.length; i++) {
        getSourceCode(x, i, addresses, contractsArr, done)
      }
    }
  })
}

// get source code and oush it to `contracts` array
function getSourceCode (x, i, addresses, contractsArr, done) {
  archive.readFile(`${addresses[x]}/src/${contractsArr[i]}`, 'utf8', (err, contract) => {
    if (err) console.log(err)
    if (contract) contracts.push(contract)
    if (counter === contracts.length) done(contracts)
  })
}
